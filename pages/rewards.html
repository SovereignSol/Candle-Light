<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rewards</title>
  <link rel="stylesheet" href="../css/style.css" />

  <style>
    .top-tabs { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .top-tab {
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      color: var(--text);
    }
    .top-tab.active { border-color: rgba(79,140,255,0.55); background: rgba(79,140,255,0.18); }
    .top-tab img { width:18px; height:18px; object-fit:contain; }

    .panel { display:none; }
    .panel.active { display:block; }

    .pr-hero {
      position: relative;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 16px;
      background:
        linear-gradient(to bottom, rgba(10,15,20,0.55), rgba(10,15,20,0.82)),
        url("images/purchase_bg.webp");
      background-size: cover;
      background-position: center;
      margin-top: 12px;
    }
    .pr-hero-inner {
      background: rgba(16,24,38,0.62);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 14px;
      backdrop-filter: blur(6px);
    }
    .pr-hero-top {
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom: 10px;
    }
    .balance-box {
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      white-space: nowrap;
    }
    .balance-box img { width:22px; height:22px; object-fit:contain; }
    .balance-label { color: var(--muted); font-size: 12px; margin-bottom: 2px; }
    .balance-value { font-size: 20px; font-weight: 800; }

    .row-2col { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 860px) { .row-2col { grid-template-columns: 1fr 1fr; } }

    .lanes { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .lane-btn {
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      color: var(--text);
    }
    .lane-btn.active { border-color: rgba(79,140,255,0.55); background: rgba(79,140,255,0.18); }
    .lane-btn img { width:18px; height:18px; object-fit:contain; }
    .lane-count { color: var(--muted); font-size: 12px; margin-left: 2px; }

    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
      width: fit-content;
    }
    .pill img { width: 14px; height: 14px; object-fit:contain; }

    .btn-icon { display:inline-flex; align-items:center; gap:8px; }
    .btn-icon img { width:18px; height:18px; object-fit:contain; }

    .sticker-img { width:52px; height:52px; border-radius:12px; object-fit:cover; border:1px solid rgba(255,255,255,0.10); }
    .award-row { display:flex; gap:12px; align-items:flex-start; }
    .card-left { display:grid; gap:4px; }

    .hint { color: var(--muted); font-size: 12px; }
  </style>
</head>

<body>
  <header class="topbar">
    <a class="link" href="../index.html">← Home</a>
    <div class="spacer"></div>
    <span id="authStatus" class="muted"></span>
    <button id="btnSignOut" class="btn btn-ghost hidden">Sign out</button>
  </header>

  <main class="container">
    <section class="card">
      <h1>Rewards</h1>

      <div class="top-tabs">
        <button class="top-tab active" data-panel="panelPR">
          <img src="icons/tab_purchase.webp" alt="">
          Purchase Requests
        </button>

        <button class="top-tab" data-panel="panelAllowance">
          <img src="icons/tab_allowance.webp" alt="">
          Allowance
        </button>

        <button class="top-tab" data-panel="panelStickerbook">
          <img src="icons/tab_stickerbook.webp" alt="">
          Sticker Book
        </button>

        <button class="top-tab" data-panel="panelWishlist">
          <img src="icons/tab_wishlist.webp" alt="">
          Wishlist
        </button>
      </div>
    </section>

    <section class="card panel active" id="panelPR">
      <div class="pr-hero">
        <div class="pr-hero-top">
          <div>
            <h2 style="margin:0;">Purchase Requests</h2>
            <div class="hint">All fields are required: Title, Cost, Link, Shipping, Sale End Date, Want Scale (1-10).</div>
          </div>

          <div class="balance-box" title="Your allowance balance">
            <img src="icons/tab_allowance.webp" alt="">
            <div>
              <div class="balance-label">Allowance</div>
              <div class="balance-value" id="myBalance">$0.00</div>
            </div>
          </div>
        </div>

        <div class="pr-hero-inner">
          <div class="row-2col">
            <div>
              <label class="label">Title</label>
              <input id="prTitle" class="input" placeholder="Title" />
            </div>

            <div>
              <label class="label">Cost</label>
              <input id="prCost" class="input" placeholder="0.00" inputmode="decimal" />
            </div>

            <div>
              <label class="label">Link</label>
              <input id="prLink" class="input" placeholder="https://..." />
            </div>

            <div>
              <label class="label">Shipping</label>
              <input id="prShip" class="input" placeholder="0.00" inputmode="decimal" />
            </div>

            <div>
              <label class="label">Sale End Date</label>
              <input id="prSaleEnd" class="input" type="date" />
            </div>

            <div>
              <label class="label">Want Scale (1-10)</label>
              <select id="prWant" class="select">
                <option value="">Select</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              </select>
            </div>
          </div>

          <div class="row">
            <button id="btnSubmitPR" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </div>

      <div class="lanes">
        <button class="lane-btn active" data-lane="pending">
          <img src="icons/status_pending.webp" alt="">
          Pending Approval <span class="lane-count" id="countPending">(0)</span>
        </button>

        <button class="lane-btn" data-lane="approved">
          <img src="icons/status_approved.webp" alt="">
          Approved <span class="lane-count" id="countApproved">(0)</span>
        </button>

        <button class="lane-btn" data-lane="denied">
          <img src="icons/status_denied.webp" alt="">
          Denied <span class="lane-count" id="countDenied">(0)</span>
        </button>
      </div>

      <div id="prLaneList" class="list"></div>
    </section>

    <section class="card panel" id="panelWishlist">
      <h2>Wishlist</h2>
      <div class="hint">Shows days in wishlist. Includes PLEASE button (only once) that returns item to Pending Approval.</div>
      <div id="wlList" class="list"></div>
    </section>

    <section class="card panel" id="panelAllowance">
      <h2>Allowance</h2>
      <div class="hint">Owner awards allowance with optional sticker attached, message is required.</div>

      <div class="kpi" id="balances"></div>

      <hr class="sep" />

      <h3>Award allowance (owner)</h3>

      <div class="row-2col">
        <div>
          <label class="label">Recipient</label>
          <select id="awUser" class="select"></select>
        </div>

        <div>
          <label class="label">Amount</label>
          <input id="awAmount" class="input" placeholder="0.00" inputmode="decimal" />
        </div>

        <div>
          <label class="label">Sticker</label>
          <select id="awSticker" class="select"></select>
        </div>

        <div>
          <label class="label">Message</label>
          <input id="awMessage" class="input" placeholder="Message" />
        </div>
      </div>

      <div class="row">
        <button id="btnAward" class="btn btn-primary">Award</button>
      </div>

      <hr class="sep" />

      <h3>Ledger</h3>
      <div id="ledger" class="list"></div>
    </section>

    <section class="card panel" id="panelStickerbook">
      <h2>Sticker Book</h2>
      <div class="hint">Displays: sticker, amount, and message attached to allowance awards.</div>

      <div id="stickerbookList" class="list"></div>

      <hr class="sep" />

      <h3>Sticker Options</h3>
      <div class="hint">Loaded from Supabase table <code>stickers</code> (images from Storage bucket <code>stickers</code>).</div>
      <div id="stickerOptionsList" class="list"></div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/config.js"></script>
  <script src="../js/supabaseClient.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/ui.js"></script>

  <script>
    const ICONS = {
      tabs: {
        purchase: "icons/tab_purchase.webp",
        allowance: "icons/tab_allowance.webp",
        stickerbook: "icons/tab_stickerbook.webp",
        wishlist: "icons/tab_wishlist.webp"
      },
      status: {
        pending: "icons/status_pending.webp",
        approved: "icons/status_approved.webp",
        denied: "icons/status_denied.webp"
      },
      actions: {
        approve: "icons/btn_approve.webp",
        deny: "icons/btn_deny.webp",
        wishlist: "icons/btn_wishlist.webp",
        please: "icons/btn_please.webp"
      }
    };

    // Top tabs
    (function(){
      const btns = Array.from(document.querySelectorAll(".top-tab"));
      btns.forEach(b => b.addEventListener("click", () => {
        btns.forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        const id = b.getAttribute("data-panel");
        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
        document.getElementById(id).classList.add("active");
      }));
    })();

    const Helpers = (() => {
      function toNumberRequired(v) {
        const s = (v || "").trim();
        if (!s) return null;
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      }
      function toIntRequired(v) {
        const s = (v || "").trim();
        if (!s) return null;
        const n = Number(s);
        return Number.isInteger(n) ? n : null;
      }
      function fmtMoney(n) {
        const num = Number(n);
        if (!Number.isFinite(num)) return "$0.00";
        return "$" + num.toFixed(2);
      }
      function daysSince(ts) {
        if (!ts) return 0;
        const t = new Date(ts).getTime();
        if (!Number.isFinite(t)) return 0;
        const diff = Date.now() - t;
        return Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
      }
      return { toNumberRequired, toIntRequired, fmtMoney, daysSince };
    })();

    const Role = (() => {
      let isOwner = false;
      async function load() {
        const uid = await Auth.getUserId();
        if (!uid) return false;
        const { data, error } = await Supa.client
          .from("app_members")
          .select("role")
          .eq("user_id", uid)
          .maybeSingle();
        if (error) return false;
        isOwner = (data?.role === "owner");
        return isOwner;
      }
      function owner() { return isOwner; }
      return { load, owner };
    })();

    const StickerStore = (() => {
      const BUCKET = "stickers";
      let list = [];
      let map = new Map();

      function publicUrl(path) {
        if (!path) return null;
        const { data } = Supa.client.storage.from(BUCKET).getPublicUrl(path);
        return data?.publicUrl || null;
      }

      async function refresh() {
        const { data, error } = await Supa.client
          .from("stickers")
          .select("id,label,image_path,is_active,sort_order,created_at")
          .order("sort_order", { ascending: true })
          .order("created_at", { ascending: false });

        if (error) {
          UI.toast(error.message);
          return;
        }

        list = data || [];
        map = new Map(list.map(s => [s.id, s]));
      }

      function all() { return list; }
      function get(id) { return map.get(id) || null; }
      function urlForStickerId(id) {
        const s = get(id);
        if (!s) return null;
        return publicUrl(s.image_path);
      }

      return { refresh, all, get, urlForStickerId };
    })();

    const Allowance = (() => {
      const el = (id) => document.getElementById(id);

      async function loadMyBalance() {
        const uid = await Auth.getUserId();
        if (!uid) return;
        const { data, error } = await Supa.client
          .from("allowance_balances")
          .select("balance")
          .eq("user_id", uid)
          .maybeSingle();
        if (!error) el("myBalance").textContent = Helpers.fmtMoney(data?.balance || 0);
      }

      async function loadBalances() {
        const { data, error } = await Supa.client
          .from("allowance_balances")
          .select("*")
          .order("user_id", { ascending: true });
        if (error) return UI.toast(error.message);

        const root = el("balances");
        root.innerHTML = "";
        if (!data || !data.length) {
          root.innerHTML = `<div class="muted">No balances yet.</div>`;
          return;
        }
        for (const b of data) {
          const box = document.createElement("div");
          box.className = "box";
          box.innerHTML = `
            <div class="muted small">User</div>
            <div class="small">${b.user_id}</div>
            <div class="muted small" style="margin-top:10px;">Balance</div>
            <div class="value">${Helpers.fmtMoney(b.balance)}</div>
          `;
          root.appendChild(box);
        }
      }

      async function loadMembersSelect() {
        const sel = el("awUser");
        sel.innerHTML = "";
        const { data, error } = await Supa.client
          .from("app_members")
          .select("user_id,role")
          .order("role", { ascending: true });
        if (error) return UI.toast(error.message);

        for (const u of (data || [])) {
          const opt = document.createElement("option");
          opt.value = u.user_id;
          opt.textContent = `${u.user_id} (${u.role})`;
          sel.appendChild(opt);
        }
      }

      async function loadStickersSelect() {
        const sel = el("awSticker");
        sel.innerHTML = "";
        const optNone = document.createElement("option");
        optNone.value = "";
        optNone.textContent = "No sticker";
        sel.appendChild(optNone);

        const stickers = StickerStore.all().filter(s => s.is_active);
        for (const s of stickers) {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.label;
          sel.appendChild(opt);
        }
      }

      async function award() {
        if (!Role.owner()) return UI.toast("Only owner can award allowance.");

        const created_by = await Auth.getUserId();
        if (!created_by) return UI.toast("Not signed in.");

        const user_id = el("awUser").value;
        const amount = Helpers.toNumberRequired(el("awAmount").value);
        const sticker_id = el("awSticker").value || null;
        const message = (el("awMessage").value || "").trim();

        if (!user_id) return UI.toast("Recipient is required.");
        if (amount === null) return UI.toast("Amount is required.");
        if (!message) return UI.toast("Message is required.");

        const payload = { user_id, amount, reason: "Allowance Award", message, sticker_id, created_by };
        const { error } = await Supa.client.from("allowance_ledger").insert(payload);
        if (error) return UI.toast(error.message);

        el("awAmount").value = "";
        el("awMessage").value = "";
        el("awSticker").value = "";
      }

      async function loadLedger() {
        const { data, error } = await Supa.client
          .from("allowance_ledger")
          .select("id,user_id,amount,reason,message,sticker_id,created_by,created_at")
          .order("created_at", { ascending: false })
          .limit(200);
        if (error) return UI.toast(error.message);

        const root = el("ledger");
        root.innerHTML = "";
        if (!data || !data.length) {
          root.innerHTML = `<div class="muted">No ledger entries yet.</div>`;
          return;
        }

        for (const it of data) {
          const row = document.createElement("div");
          row.className = "list-row";

          const left = document.createElement("div");
          left.className = "card-left";

          const title = document.createElement("div");
          title.className = "pr-title";
          title.textContent = `${it.reason || "Ledger"} (${it.amount >= 0 ? "+" : ""}${Number(it.amount).toFixed(2)})`;

          const meta = document.createElement("div");
          meta.className = "muted small";
          meta.textContent = `user: ${it.user_id} • ${new Date(it.created_at).toLocaleString()}`;

          const msg = document.createElement("div");
          msg.className = "muted small";
          msg.textContent = it.message ? `message: ${it.message}` : "";

          left.appendChild(title);
          left.appendChild(meta);
          if (it.message) left.appendChild(msg);

          row.appendChild(left);
          root.appendChild(row);
        }
      }

      function wire() {
        document.getElementById("btnAward").addEventListener("click", award);
      }

      return { loadMyBalance, loadBalances, loadMembersSelect, loadStickersSelect, loadLedger, wire };
    })();

    const Stickerbook = (() => {
      async function loadStickerAwards() {
        const { data, error } = await Supa.client
          .from("allowance_ledger")
          .select("id,user_id,amount,message,sticker_id,created_at")
          .order("created_at", { ascending: false })
          .limit(200);
        if (error) return UI.toast(error.message);

        const root = document.getElementById("stickerbookList");
        root.innerHTML = "";

        const awards = (data || []).filter(x => x.message && x.message.trim().length);
        if (!awards.length) {
          root.innerHTML = `<div class="muted">No sticker awards yet.</div>`;
          return;
        }

        for (const a of awards) {
          const row = document.createElement("div");
          row.className = "list-row";

          const left = document.createElement("div");
          left.className = "award-row";

          const st = a.sticker_id ? StickerStore.get(a.sticker_id) : null;
          const imgUrl = a.sticker_id ? StickerStore.urlForStickerId(a.sticker_id) : null;

          if (imgUrl) {
            const img = document.createElement("img");
            img.className = "sticker-img";
            img.src = imgUrl;
            img.alt = st?.label || "sticker";
            left.appendChild(img);
          }

          const text = document.createElement("div");
          text.className = "card-left";

          const title = document.createElement("div");
          title.className = "pr-title";
          title.textContent = `${st?.label ? st.label + " • " : ""}${Helpers.fmtMoney(a.amount)}`;

          const msg = document.createElement("div");
          msg.className = "muted";
          msg.textContent = a.message || "";

          const meta = document.createElement("div");
          meta.className = "muted small";
          meta.textContent = `${new Date(a.created_at).toLocaleString()}`;

          text.appendChild(title);
          text.appendChild(msg);
          text.appendChild(meta);

          left.appendChild(text);
          row.appendChild(left);
          root.appendChild(row);
        }
      }

      async function loadStickerOptions() {
        const root = document.getElementById("stickerOptionsList");
        root.innerHTML = "";

        const stickers = StickerStore.all();
        if (!stickers.length) {
          root.innerHTML = `<div class="muted">No stickers found. Add rows in Supabase table <code>stickers</code>.</div>`;
          return;
        }

        for (const s of stickers) {
          const row = document.createElement("div");
          row.className = "list-row";

          const left = document.createElement("div");
          left.className = "award-row";

          const imgUrl = StickerStore.urlForStickerId(s.id);
          if (imgUrl) {
            const img = document.createElement("img");
            img.className = "sticker-img";
            img.src = imgUrl;
            img.alt = s.label;
            left.appendChild(img);
          }

          const text = document.createElement("div");
          text.className = "card-left";

          const title = document.createElement("div");
          title.className = "pr-title";
          title.textContent = s.label;

          const meta = document.createElement("div");
          meta.className = "muted small";
          meta.textContent = `Active: ${s.is_active ? "yes" : "no"} • sort: ${s.sort_order}${s.image_path ? " • image: yes" : ""}`;

          text.appendChild(title);
          text.appendChild(meta);

          left.appendChild(text);
          row.appendChild(left);
          root.appendChild(row);
        }
      }

      return { loadStickerAwards, loadStickerOptions };
    })();

    const PR = (() => {
      let currentLane = "pending";

      function laneName(status) {
        if (status === "pending") return "pending";
        if (status === "approved") return "approved";
        if (status === "denied") return "denied";
        if (status === "wishlist") return "wishlist";
        return "pending";
      }

      function pill(status, pleaseCount) {
        const d = document.createElement("div");
        d.className = "pill";
        const img = document.createElement("img");
        img.src = (status === "pending") ? ICONS.status.pending
          : (status === "approved") ? ICONS.status.approved
          : ICONS.status.denied;

        const t = document.createElement("span");
        t.textContent = status.toUpperCase() + (pleaseCount >= 1 ? " • PLEASE" : "");

        d.appendChild(img);
        d.appendChild(t);
        return d;
      }

      function metaText(it) {
        return `Cost: ${it.cost} • Shipping: ${it.shipping_cost} • Sale End: ${it.sale_end_date} • Want: ${it.want_scale}`;
      }

      async function loadAll() {
        const { data, error } = await Supa.client
          .from("purchase_requests")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) return UI.toast(error.message);

        const items = data || [];
        const pending = items.filter(x => laneName(x.status) === "pending");
        const approved = items.filter(x => laneName(x.status) === "approved");
        const denied = items.filter(x => laneName(x.status) === "denied");
        const wishlist = items.filter(x => laneName(x.status) === "wishlist");

        document.getElementById("countPending").textContent = `(${pending.length})`;
        document.getElementById("countApproved").textContent = `(${approved.length})`;
        document.getElementById("countDenied").textContent = `(${denied.length})`;

        renderLane(currentLane, { pending, approved, denied });
        renderWishlist(wishlist);
      }

      function attachLaneButtons() {
        const laneBtns = Array.from(document.querySelectorAll(".lane-btn"));
        laneBtns.forEach(b => b.addEventListener("click", () => {
          laneBtns.forEach(x => x.classList.remove("active"));
          b.classList.add("active");
          currentLane = b.getAttribute("data-lane");
          loadAll();
        }));
      }

      async function updateStatus(it, status) {
        const payload = { status };
        const { error } = await Supa.client
          .from("purchase_requests")
          .update(payload)
          .eq("id", it.id);
        if (error) UI.toast(error.message);
      }

      async function pleaseOnce(it) {
        const current = it.please_count || 0;
        if (current >= 1) return UI.toast("PLEASE can only be used once.");

        const { error } = await Supa.client
          .from("purchase_requests")
          .update({ status: "pending", please_count: 1 })
          .eq("id", it.id);

        if (error) UI.toast(error.message);
      }

      function renderLane(lane, groups) {
        const root = document.getElementById("prLaneList");
        root.innerHTML = "";

        let list = [];
        if (lane === "pending") list = groups.pending;
        if (lane === "approved") list = groups.approved;
        if (lane === "denied") list = groups.denied;

        if (!list.length) {
          root.innerHTML = `<div class="muted">No items in this section.</div>`;
          return;
        }

        for (const it of list) {
          const row = document.createElement("div");
          row.className = "list-row";

          const left = document.createElement("div");
          left.className = "card-left";

          const status = laneName(it.status);
          left.appendChild(pill(status, it.please_count || 0));

          const title = document.createElement("div");
          title.className = "pr-title";
          title.textContent = it.title;

          const meta = document.createElement("div");
          meta.className = "muted small";
          meta.textContent = metaText(it);

          const link = document.createElement("a");
          link.className = "link small";
          link.href = it.link;
          link.textContent = "Open link";
          link.target = "_blank";
          link.rel = "noreferrer";

          left.appendChild(title);
          left.appendChild(meta);
          left.appendChild(link);

          const right = document.createElement("div");
          right.className = "pr-actions";

          if (status === "pending") {
            const approve = document.createElement("button");
            approve.className = "btn btn-primary btn-icon";
            approve.innerHTML = `<img src="${ICONS.actions.approve}" alt="">Approve`;
            approve.onclick = () => updateStatus(it, "approved");

            const deny = document.createElement("button");
            deny.className = "btn btn-danger btn-icon";
            deny.innerHTML = `<img src="${ICONS.actions.deny}" alt="">Deny`;
            deny.onclick = () => updateStatus(it, "denied");

            if (!Role.owner()) {
              approve.disabled = true;
              deny.disabled = true;
              approve.title = "Owner only";
              deny.title = "Owner only";
            }

            right.appendChild(approve);
            right.appendChild(deny);
          }

          if (status === "approved") {
            const undo = document.createElement("button");
            undo.className = "btn btn-ghost";
            undo.textContent = "Undo";
            undo.onclick = () => updateStatus(it, "denied");
            right.appendChild(undo);
          }

          if (status === "denied") {
            const wl = document.createElement("button");
            wl.className = "btn btn-ghost btn-icon";
            wl.innerHTML = `<img src="${ICONS.actions.wishlist}" alt="">Wishlist`;
            wl.onclick = () => updateStatus(it, "wishlist");

            const please = document.createElement("button");
            please.className = "btn btn-primary btn-icon";
            please.innerHTML = `<img src="${ICONS.actions.please}" alt="">PLEASE :(`;
            please.onclick = () => pleaseOnce(it);

            if ((it.please_count || 0) >= 1) {
              please.disabled = true;
              please.title = "Already used";
            }

            right.appendChild(wl);
            right.appendChild(please);
          }

          row.appendChild(left);
          row.appendChild(right);
          root.appendChild(row);
        }
      }

      function renderWishlist(items) {
        const root = document.getElementById("wlList");
        root.innerHTML = "";

        if (!items.length) {
          root.innerHTML = `<div class="muted">No items in wishlist.</div>`;
          return;
        }

        for (const it of items) {
          const row = document.createElement("div");
          row.className = "list-row";

          const left = document.createElement("div");
          left.className = "card-left";

          const title = document.createElement("div");
          title.className = "pr-title";
          title.textContent = it.title;

          const days = Helpers.daysSince(it.wishlist_at);
          const meta = document.createElement("div");
          meta.className = "muted small";
          meta.textContent = `${metaText(it)} • Days in wishlist: ${days}`;

          const link = document.createElement("a");
          link.className = "link small";
          link.href = it.link;
          link.textContent = "Open link";
          link.target = "_blank";
          link.rel = "noreferrer";

          left.appendChild(title);
          left.appendChild(meta);
          left.appendChild(link);

          const right = document.createElement("div");
          right.className = "pr-actions";

          const please = document.createElement("button");
          please.className = "btn btn-primary btn-icon";
          please.innerHTML = `<img src="${ICONS.actions.please}" alt="">PLEASE :(`;
          please.onclick = () => pleaseOnce(it);

          if ((it.please_count || 0) >= 1) {
            please.disabled = true;
            please.title = "Already used";
          }

          right.appendChild(please);

          row.appendChild(left);
          row.appendChild(right);
          root.appendChild(row);
        }
      }

      async function submit() {
        const title = (document.getElementById("prTitle").value || "").trim();
        const cost = Helpers.toNumberRequired(document.getElementById("prCost").value);
        const link = (document.getElementById("prLink").value || "").trim();
        const shipping = Helpers.toNumberRequired(document.getElementById("prShip").value);
        const saleEnd = (document.getElementById("prSaleEnd").value || "").trim();
        const want = Helpers.toIntRequired(document.getElementById("prWant").value);

        const userId = await Auth.getUserId();
        if (!userId) return UI.toast("Not signed in.");

        if (!title) return UI.toast("Title is required.");
        if (cost === null) return UI.toast("Cost is required.");
        if (!link) return UI.toast("Link is required.");
        if (shipping === null) return UI.toast("Shipping is required.");
        if (!saleEnd) return UI.toast("Sale End Date is required.");
        if (want === null || want < 1 || want > 10) return UI.toast("Want Scale (1-10) is required.");

        const payload = {
          title,
          link,
          cost,
          shipping_cost: shipping,
          sale_end_date: saleEnd,
          want_scale: want,
          status: "pending",
          created_by: userId,
          please_count: 0
        };

        const { error } = await Supa.client.from("purchase_requests").insert(payload);
        if (error) return UI.toast(error.message);

        document.getElementById("prTitle").value = "";
        document.getElementById("prCost").value = "";
        document.getElementById("prLink").value = "";
        document.getElementById("prShip").value = "";
        document.getElementById("prSaleEnd").value = "";
        document.getElementById("prWant").value = "";
      }

      function wire() {
        attachLaneButtons();
        document.getElementById("btnSubmitPR").addEventListener("click", submit);
      }

      function subscribeRealtime() {
        const ch = Supa.client.channel("rt-pr");
        ch.on("postgres_changes", { event: "*", schema: "public", table: "purchase_requests" }, () => loadAll());
        ch.subscribe();
      }

      return { wire, loadAll, subscribeRealtime };
    })();

    function subscribeOtherRealtime() {
      const ch1 = Supa.client.channel("rt-ledger");
      ch1.on("postgres_changes", { event: "*", schema: "public", table: "allowance_ledger" }, async () => {
        await Allowance.loadMyBalance();
        await Allowance.loadBalances();
        await Allowance.loadLedger();
        await Stickerbook.loadStickerAwards();
      });
      ch1.subscribe();

      const ch2 = Supa.client.channel("rt-stickers");
      ch2.on("postgres_changes", { event: "*", schema: "public", table: "stickers" }, async () => {
        await StickerStore.refresh();
        await Allowance.loadStickersSelect();
        await Stickerbook.loadStickerOptions();
        await Stickerbook.loadStickerAwards();
      });
      ch2.subscribe();
    }

    async function refreshAll() {
      await StickerStore.refresh();
      await Role.load();

      await Allowance.loadMyBalance();
      await Allowance.loadBalances();
      await Allowance.loadMembersSelect();
      await Allowance.loadStickersSelect();
      await Allowance.loadLedger();

      await Stickerbook.loadStickerAwards();
      await Stickerbook.loadStickerOptions();

      await PR.loadAll();
    }

    (async () => {
      const ok = await Auth.requireSessionOrRedirect();
      if (!ok) return;

      await Auth.initHeaderUI();

      PR.wire();
      Allowance.wire();

      await refreshAll();

      PR.subscribeRealtime();
      subscribeOtherRealtime();
    })();
  </script>
</body>
</html>
